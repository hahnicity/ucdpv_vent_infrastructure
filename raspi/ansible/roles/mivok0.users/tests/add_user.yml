# ucdv_vent_infrastructure "Platform for collecting, aggregating, and storing ventilator data"
# Copyright (C) 2017 Gregory Rehm
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
---

# It should add a user when given valid metadata

- hosts: test_runners
  sudo: yes

# Test fixture data
  vars:
    users:
      - username: ansibletestuser
        name: Ansible Users Role Test Fixture Account
        groups:
          - 'users'
          - 'bin'
        uid: 2222
        ssh_key:
          - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDVpUJQCOaPg3p5xro9e+1fkGRWNOGrrExiKMqTE91Fwu349bxfMnMzRS0PAERouR9EEL+Ee4Yzhav/uNc35eCtXzACtluXnAncMrQj6pM3IqASynhvXTygHljmcMbBSDQtLrTZeW+YzIcOgk5UM1yBi26WoUYva2aCr9IRvKdYreAK08OiMdZedpOye0ZdvIYJGcyITwc6YMmrAhP7jZlrk/mDEkf2a4eBp+475o7MJtaC9npqYkToM8vqvx5AGEKqXt7/f1/paOY7KsR+VGPQy6k2RkXjWBsXPesZ3d3XLZHE60wAk0EsuJO8A25+uWSB6ILQeRSYYmGea/WIf6kd noone@throwaway.example.com"

# Test setup
  pre_tasks:
    - include: cleanup.yml
    - name: Add Users Test | Pre-Assertions | Ensure ansibletestuser not already present
      command: "grep ansibletestuser /etc/passwd /etc/group"
      register: ensure_user_not_present
      failed_when: ensure_user_not_present.rc == 0
    - name: Add Users Test | Pre-Assertions | Ensure ansibletestuser home dir not already present
      command: "ls -d /home/ansibletestuser"
      register: ensure_home_not_present
      failed_when: ensure_home_not_present.rc == 0

# Test run
  roles:
    - { role: users }

# Test verify successful
  tasks:
    - name: Add Users Test | Post-Assertions | Ensure ansibletestuser was created
      command: "grep ansibletestuser /etc/passwd"
    - name: Add Users Test | Post-Assertions | Ensure ansibletestuser home dir was created
      command: "ls -d /home/ansibletestuser"
    - name: Add Users Test | Post-Assertions | Ensure ssh key was added
      command: "sudo grep '{{ users[0].ssh_key[0] }}' /home/ansibletestuser/.ssh/authorized_keys"
    - name: Add Users Test | Post-Assertions | Ensure group was added
      command: "grep 2222 /etc/group"
    - name: Add Users Test |  Post-Assertions | Ensure user was added to requested groups
      command: "grep '^bin.*ansibletestuser' /etc/group"

# Test tear-down
  post_tasks:
    - include: cleanup.yml

