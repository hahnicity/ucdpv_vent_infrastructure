# ucdv_vent_infrastructure "Platform for collecting, aggregating, and storing ventilator data"
# Copyright (C) 2017 Gregory Rehm
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
---

# SSH keys should not be required

- hosts: test_runners
  sudo: yes

# Test fixture data
  vars:
    users:
      - username: ansibletestuser
        name: Ansible Users Role Test Fixture Account
        uid: 2222
        groups: []
        ssh_key: []

# Test setup
  pre_tasks:
    - include: cleanup.yml
    - name: SSH Keys Optional Test | Pre-Assertions | Ensure ansibletestuser not already present
      command: "grep ansibletestuser /etc/passwd /etc/group"
      register: ensure_user_not_present
      failed_when: ensure_user_not_present.rc == 0
    - name: SSH Keys Optional Test | Pre-Assertions | Ensure ansibletestuser home dir not already present
      command: "ls -d /home/ansibletestuser"
      register: ensure_home_not_present
      failed_when: ensure_home_not_present.rc == 0

# Test run
  roles:
    - { role: users }

# Test verify successful
  tasks:
    - name: SSH Keys Optional Test | Post-Assertions | Ensure ansibletestuser was created
      command: "grep ansibletestuser /etc/passwd"
    - name: SSH Keys Optional Test | Post-Assertions | Ensure no ssh key was added
      command: "sudo ls /home/ansibletestuser/.ssh/authorized_keys"
      register: ensure_ssh_key_not_present
      failed_when: ensure_ssh_key_not_present.rc == 0

# Test tear-down
  post_tasks:
    - include: cleanup.yml

