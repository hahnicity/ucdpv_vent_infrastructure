# XXX copyright

import multiprocessing
import os
import signal
import socket
import subprocess
import time

import mock
import serial

import get_serial

DATA_PATH = "/home/pi/Data"
MOCK_DATE_OUT = "1000"
WRITE_TTY = "/dev/ttyS10"
READ_TTY = "/dev/ttyS11"
B1 = """BS, S:65430,
3.17, 11.27
10.14, 11.40
23.76, 12.42
40.59, 14.39
53.57, 17.29
59.59, 20.74
59.11, 24.33
49.19, 26.62
43.00, 27.33
40.43, 27.74
38.89, 28.14
38.14, 28.39
36.46, 28.46
34.59, 28.51
33.58, 28.26
31.57, 28.07
32.44, 28.04
33.93, 28.26
35.37, 28.58
36.20, 28.91
35.59, 29.25
32.88, 29.41
32.64, 29.32
32.15, 29.34
32.73, 29.28
31.29, 29.41
30.70, 29.44
30.82, 29.43
30.05, 29.46
29.10, 29.49
28.50, 29.55
25.89, 29.56
23.70, 29.48
24.58, 29.51
21.84, 29.53
20.32, 29.45
18.10, 29.44
18.01, 29.42
16.20, 29.49
14.27, 29.50
-60.92, 28.93
-71.30, 24.57
-59.03, 18.46
-29.13, 14.94
-22.38, 14.93
-26.78, 16.36
-34.08, 16.33
-35.06, 15.24
-32.72, 14.54
-31.73, 14.27
-30.51, 14.16
-30.16, 13.99
-28.99, 13.82
-28.65, 13.65
-28.11, 13.50
-28.68, 13.40
-26.41, 13.32
-26.76, 13.31
-25.37, 13.23
-26.25, 13.15
-25.97, 13.01
-25.25, 12.92
-24.45, 12.90
-24.56, 12.82
-23.01, 12.75
-22.65, 12.73
-20.99, 12.64
-20.58, 12.58
-20.44, 12.57
-20.20, 12.56
-19.90, 12.48
-19.39, 12.48
-19.55, 12.42
-18.02, 12.39
-18.06, 12.33
-17.16, 12.32
-16.70, 12.31
-15.67, 12.28
-16.27, 12.37
-15.68, 12.31
-15.76, 12.31
-15.07, 12.15
-14.70, 12.04
-12.96, 11.99
-11.78, 12.11
-12.33, 12.20
-12.18, 12.16
-12.29, 12.14
-11.89, 12.16
-11.40, 12.13
-11.15, 12.06
-11.24, 12.02
-9.62, 11.90
-8.97, 11.81
-7.42, 11.76
-7.02, 11.82
-5.94, 11.78
-5.40, 11.73
-3.62, 11.68
-2.73, 11.64
-1.26, 11.55
0.20, 11.53
1.91, 11.49
2.84, 11.43
BE
"""
B2 = """BS, S:65431,
3.45, 11.33
9.37, 11.47
23.94, 12.52
40.71, 14.46
52.10, 17.36
58.71, 20.74
57.98, 24.25
49.05, 26.62
42.72, 27.29
39.57, 27.74
39.59, 28.14
38.07, 28.39
35.75, 28.53
34.70, 28.49
33.17, 28.33
32.33, 28.14
32.25, 28.12
33.71, 28.28
34.47, 28.53
35.74, 28.84
35.69, 29.09
33.45, 29.35
32.33, 29.36
32.34, 29.19
31.99, 29.33
32.04, 29.37
31.61, 29.35
30.77, 29.38
30.43, 29.44
29.17, 29.48
28.10, 29.48
26.88, 29.47
25.97, 29.45
25.58, 29.36
23.86, 29.35
23.94, 29.34
22.66, 29.41
22.20, 29.40
20.11, 29.40
18.70, 29.41
16.58, 29.49
14.63, 29.48
-52.14, 29.17
-70.25, 25.96
-67.48, 20.06
-35.62, 15.33
-24.08, 14.50
-23.76, 16.14
-32.46, 16.22
-34.57, 15.61
-34.41, 14.75
-32.90, 14.34
-31.66, 14.18
-30.98, 14.02
-29.81, 13.84
-30.17, 13.69
-28.13, 13.59
-28.70, 13.56
-27.17, 13.42
-27.62, 13.32
-27.01, 13.16
-27.20, 13.14
-25.86, 13.00
-25.73, 12.90
-24.42, 12.83
-23.96, 12.81
-22.85, 12.73
-21.74, 12.73
-22.07, 12.64
-21.16, 12.64
-20.77, 12.59
-20.31, 12.56
-20.37, 12.48
-19.29, 12.48
-19.14, 12.42
-18.34, 12.40
-18.02, 12.39
-17.59, 12.39
-17.96, 12.31
-17.13, 12.25
-16.60, 12.26
-15.21, 12.22
-15.18, 12.15
-14.53, 12.23
-13.72, 12.23
-14.13, 12.23
-13.65, 12.22
-13.61, 12.14
-13.13, 12.14
-12.36, 12.05
-12.30, 12.05
-11.71, 12.06
-10.54, 11.97
-9.81, 11.95
-8.86, 11.97
-8.99, 12.05
-8.94, 12.05
-8.84, 12.00
-8.52, 11.97
-7.95, 11.96
-6.89, 11.84
-5.84, 11.73
-4.18, 11.69
-3.13, 11.67
-1.56, 11.65
-0.75, 11.64
0.25, 11.56
1.64, 11.53
BE
"""
B3 = """BS, S:65432,
3.80, 11.49
9.57, 11.62
23.13, 12.62
40.39, 14.47
52.05, 17.20
59.36, 20.56
60.46, 24.13
48.84, 26.47
43.37, 27.19
41.01, 27.65
41.33, 28.05
38.68, 28.38
36.38, 28.47
35.26, 28.52
34.20, 28.49
33.05, 28.20
32.62, 28.14
33.73, 28.28
34.48, 28.49
35.89, 28.80
36.47, 29.08
33.37, 29.36
32.60, 29.29
32.11, 29.30
31.91, 29.36
32.03, 29.34
30.45, 29.35
30.42, 29.40
29.88, 29.43
29.11, 29.47
27.37, 29.40
27.15, 29.37
26.84, 29.37
25.24, 29.35
24.87, 29.26
25.21, 29.24
24.24, 29.23
23.59, 29.32
22.24, 29.40
19.78, 29.43
17.74, 29.43
16.07, 29.43
14.59, 29.50
-61.38, 28.90
-73.13, 24.59
-60.72, 18.43
-28.35, 14.94
-23.36, 14.83
-25.79, 16.23
-34.33, 16.18
-35.14, 15.22
-35.35, 14.66
-32.87, 14.33
-32.55, 14.23
-30.58, 14.07
-31.60, 13.84
-29.39, 13.66
-28.52, 13.57
-28.82, 13.56
-27.67, 13.40
-27.43, 13.32
-27.05, 13.15
-25.64, 13.06
-24.22, 12.98
-24.56, 12.98
-24.13, 12.97
-24.43, 12.98
-24.70, 12.84
-25.17, 12.67
-23.08, 12.65
-23.56, 12.64
-21.83, 12.59
-21.02, 12.55
-20.02, 12.56
-19.87, 12.50
-19.68, 12.54
-19.38, 12.49
-19.28, 12.47
-18.99, 12.40
-17.83, 12.39
-16.42, 12.31
-16.77, 12.25
-15.55, 12.23
-15.75, 12.31
-15.45, 12.25
-14.89, 12.22
-15.05, 12.22
-14.70, 12.14
-13.72, 12.14
-13.29, 12.00
-12.18, 11.97
-11.84, 11.97
-11.12, 12.11
-11.22, 12.22
-11.48, 12.18
-11.74, 12.14
-10.68, 12.06
-10.80, 12.06
-9.27, 12.05
-8.74, 11.98
-8.40, 11.91
-7.44, 11.93
-7.22, 11.98
-6.86, 11.99
-7.22, 12.05
-6.55, 12.06
-6.74, 12.06
-6.15, 12.06
-6.31, 11.99
-5.79, 11.90
-5.38, 11.81
-3.85, 11.77
-2.71, 11.75
-1.68, 11.73
-0.59, 11.71
0.57, 11.69
1.79, 11.53
3.00, 11.33
BE
"""
FILENAME = os.path.join(DATA_PATH, "{}-{}.csv".format(socket.gethostname(), MOCK_DATE_OUT))


def write_to_serial():
    writer = serial.Serial(port=WRITE_TTY, baudrate=38400)
    breaths = [B1, B2, B3]
    for breath in breaths:
        b_lines = len(breath.split('\n'))
        writer.write(breath)
        writer.flush()
        time.sleep(.02 * b_lines)
    writer.close()


def start_reader():
    with mock.patch("get_serial.datetime") as mock_dt:
        with mock.patch('get_serial.time') as mock_time:
            mock_time.time.return_value = int(MOCK_DATE_OUT) + 1
            mock_dt.datetime.now().strftime.return_value = MOCK_DATE_OUT
            p = multiprocessing.Process(target=get_serial.get_serial, args=("testing_bg",))
            p.start()
    time.sleep(3)
    return p


def write_and_get_output():
    write_to_serial()
    time.sleep(2)
    with open(FILENAME) as f:
        test_output = f.read()
    return test_output


def validate_output(output):
    expected_output = "{0}\n{1}{0}\n{2}{0}\n{3}{0}\n".format(MOCK_DATE_OUT, B1, B2, B3)
    assert output == expected_output


def teardown(reader_proc, socat_proc):
    """
    kill socat and bg python
    """
    os.remove(FILENAME)
    reader_proc.terminate()
    reader_proc.join()
    socat_proc.kill()


def main():
    # start socat process and just wait a bit to make sure no race condition happens
    socat_proc = subprocess.Popen("socat PTY,link={} PTY,link={}".format(WRITE_TTY, READ_TTY).split(" "), close_fds=True)
    reader_proc = start_reader()
    test_output = write_and_get_output()
    validate_output(test_output)
    teardown(reader_proc, socat_proc)


if __name__ == "__main__":
    main()
